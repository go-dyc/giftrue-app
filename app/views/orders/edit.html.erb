<div class="min-h-screen bg-gray-50 py-4">
  <div class="max-w-2xl mx-auto px-4">
    <!-- Header -->
    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">ê¸°í”„íŠ¸ë£¨ ì¸ë¬¼ í”¼ê·œì–´ ì •ë³´ ì…ë ¥</h1>
      <p class="text-gray-600">ë‹¨ê³„ë³„ë¡œ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
    </div>

    <!-- Progress Bar -->
    <div class="mb-6">
      <div class="flex justify-between items-center mb-2">
        <span class="text-sm font-medium text-gray-700">ì§„í–‰ ìƒí™©</span>
        <span class="text-sm font-medium text-gray-700"><%= @step %>/3 ë‹¨ê³„</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
             style="width: <%= (@step.to_f / 3 * 100).round(1) %>%"></div>
      </div>
      <div class="flex justify-between mt-1">
        <span class="text-xs text-gray-500 <%= 'font-semibold text-blue-600' if @step >= 1 %>">ì •ë©´ ì‚¬ì§„</span>
        <span class="text-xs text-gray-500 <%= 'font-semibold text-blue-600' if @step >= 2 %>">í¬ì¦ˆ ë° ì˜ìƒ ì •ë³´</span>
        <span class="text-xs text-gray-500 <%= 'font-semibold text-blue-600' if @step >= 3 %>">ê¸°ë…íŒ¨ ìŠ¤íƒ€ì¼ ì„ íƒ</span>
      </div>
    </div>

    <!-- Form Card -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <%= form_with model: @order, url: @order.persisted? ? order_path(@order.naver_order_number) : orders_path, 
                    method: @order.persisted? ? :patch : :post, 
                    local: true, 
                    multipart: true, 
                    class: "space-y-8",
                    data: { turbo: false } do |form| %>
        
        <%= hidden_field_tag :step, @step %>
        <%= hidden_field_tag :naver_order_number, @order.naver_order_number unless @order.persisted? %>
        <% if @step < 3 %>
          <%= hidden_field_tag :next_step, @step + 1 %>
        <% else %>
          <%= hidden_field_tag :complete_step, true %>
        <% end %>

        <!-- Step 1: Basic Information -->
        <% if @step == 1 %>
          <div class="space-y-6">
            <div>
              <h2 class="text-xl font-semibold text-gray-900 mb-4">1ë‹¨ê³„: ì •ë©´ ì‚¬ì§„</h2>
            </div>
            
            <!-- Orderer Name -->
            <div>
              <%= form.label :orderer_name, "ì£¼ë¬¸ì ì„±í•¨ *", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_field :orderer_name, 
                    class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 #{'border-red-300' if @order.errors[:orderer_name].any?}",
                    placeholder: "ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”",
                    required: true,
                    id: "orderer_name_input" %>
              <% if @order.errors[:orderer_name].any? %>
                <p class="text-red-500 text-sm mt-1"><%= @order.errors[:orderer_name].first %></p>
              <% end %>
              <!-- í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì—ëŸ¬ ë©”ì‹œì§€ -->
              <p id="orderer_name_error" class="text-red-500 text-sm mt-1 hidden"></p>
            </div>

            <!-- Main Images -->
            <div>
              <%= form.label :main_images, "ë©”ì¸ ì‚¬ì§„ ì—…ë¡œë“œ *", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <p class="text-sm text-gray-600 mb-3">ìµœëŒ€ 5ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
              
              <!-- Image Upload Slots -->
              <div class="grid grid-cols-5 gap-2 mb-4" id="image_slots">
                <% 5.times do |i| %>
                  <div class="image-slot aspect-square border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center hover:border-blue-400 transition-all cursor-pointer text-center p-2" 
                       data-slot="<%= i %>">
                    <svg class="w-4 h-4 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span class="text-xs text-gray-500 mt-1"><%= i + 1 %></span>
                  </div>
                <% end %>
              </div>
              
              <%= form.file_field :main_images, 
                    multiple: true, 
                    accept: "image/jpeg,image/png",
                    class: "hidden",
                    id: "main_images_input" %>
              
              <div class="text-center">
                <label for="main_images_input" class="btn-primary cursor-pointer">
                  ì‚¬ì§„ ì„ íƒí•˜ê¸°
                </label>
                <p class="text-xs text-gray-500 mt-2">JPG, PNG íŒŒì¼ | ê°œë‹¹ ìµœëŒ€ 10MB</p>
              </div>
              
              <% if @order.errors[:main_images].any? %>
                <p class="text-red-500 text-sm mt-2"><%= @order.errors[:main_images].first %></p>
              <% end %>
              <!-- í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì—ëŸ¬ ë©”ì‹œì§€ -->
              <p id="main_images_error" class="text-red-500 text-sm mt-2 hidden"></p>
            </div>
          </div>
        <% end %>

        <!-- Step 2: Additional Information -->
        <% if @step == 2 %>
          <div class="space-y-6">
            <div>
              <h2 class="text-xl font-semibold text-gray-900 mb-4">2ë‹¨ê³„: í¬ì¦ˆ ë° ì˜ìƒ ì •ë³´ (ì„ íƒì‚¬í•­)</h2>
            </div>
            
            <!-- Optional Images -->
            <div>
              <%= form.label :optional_images, "ì¶”ê°€ ì‚¬ì§„ (ì„ íƒ)", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <p class="text-sm text-gray-600 mb-3">ìµœëŒ€ 5ê°œê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
              
              <!-- Image Upload Slots for Optional Images -->
              <div class="grid grid-cols-5 gap-2 mb-4" id="optional_image_slots">
                <% 5.times do |i| %>
                  <div class="optional-image-slot aspect-square border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center hover:border-blue-400 transition-all cursor-pointer text-center p-2" 
                       data-slot="<%= i %>">
                    <svg class="w-4 h-4 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <span class="text-xs text-gray-500 mt-1"><%= i + 1 %></span>
                  </div>
                <% end %>
              </div>
              
              <%= form.file_field :optional_images, 
                    multiple: true, 
                    accept: "image/jpeg,image/png",
                    class: "hidden",
                    id: "optional_images_input" %>
              
              <div class="text-center">
                <label for="optional_images_input" class="btn-primary cursor-pointer">
                  ì‚¬ì§„ ì—…ë¡œë“œ
                </label>
                <p class="text-xs text-gray-500 mt-2">JPG, PNG íŒŒì¼ | ê°œë‹¹ ìµœëŒ€ 10MB</p>
              </div>
              
              <% if @order.errors[:optional_images].any? %>
                <p class="text-red-500 text-sm mt-2"><%= @order.errors[:optional_images].first %></p>
              <% end %>
            </div>

            <!-- Additional Requests -->
            <div>
              <%= form.label :additional_requests, "ì¶”ê°€ ìš”ì²­ì‚¬í•­ (ì„ íƒ)", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_area :additional_requests, 
                    class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none",
                    rows: 4,
                    placeholder: "ì œì‘ ì‹œ íŠ¹ë³„íˆ ê³ ë ¤í•´ì•¼ í•  ì‚¬í•­ì´ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”..." %>
            </div>
          </div>
        <% end %>

        <!-- Step 3: Style and Message -->
        <% if @step == 3 %>
          <div class="space-y-6">
            <div>
              <h2 class="text-xl font-semibold text-gray-900 mb-4">3ë‹¨ê³„: ìŠ¤íƒ€ì¼ ë° ë¬¸êµ¬</h2>
            </div>
            
            <!-- Plaque Style Selection -->
            <div>
              <%= form.label :plaque_style, "ê¸°ë…íŒ¨ ìŠ¤íƒ€ì¼ *", class: "block text-sm font-medium text-gray-700 mb-3" %>
              <div class="grid grid-cols-2 gap-3">
                <% [
                  { value: 'gold_metal', name: 'ê¸ˆì†íŒ¨ (ê³¨ë“œ)', desc: 'ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ê³¨ë“œ' },
                  { value: 'silver_metal', name: 'ê¸ˆì†íŒ¨ (ì‹¤ë²„)', desc: 'ê¹”ë”í•œ ì‹¤ë²„' },
                  { value: 'acrylic_cartoon', name: 'ì•„í¬ë¦´íŒ¨ (ì¹´íˆ°)', desc: 'ê·€ì—¬ìš´ ì¹´íˆ°ìŠ¤íƒ€ì¼' },
                  { value: 'acrylic_realistic', name: 'ì•„í¬ë¦´íŒ¨ (ì‹¤ì‚¬)', desc: 'ìƒìƒí•œ ì‹¤ì‚¬ìŠ¤íƒ€ì¼' }
                ].each do |style| %>
                  <div class="relative">
                    <%= form.radio_button :plaque_style, style[:value], 
                          class: "hidden peer",
                          id: "style_#{style[:value]}" %>
                    <label for="style_<%= style[:value] %>" 
                           class="block cursor-pointer border-2 border-gray-200 rounded-lg p-4 hover:border-blue-400 peer-checked:border-blue-500 peer-checked:bg-blue-50 transition-all">
                      <div class="text-center">
                        <div class="w-full h-32 bg-gray-100 rounded-md mb-3 overflow-hidden">
                          <img src="/images/plaques/<%= style[:value] %>.png" 
                               class="w-full h-full object-contain"
                               alt="<%= style[:name] %>"
                               onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                          <div class="w-full h-full flex items-center justify-center text-gray-500 text-sm" style="display: none;">
                            <%= style[:name] %>
                          </div>
                        </div>
                        <h3 class="font-medium text-gray-900 text-sm"><%= style[:name] %></h3>
                        <p class="text-xs text-gray-600"><%= style[:desc] %></p>
                      </div>
                    </label>
                  </div>
                <% end %>
              </div>
              <% if @order.errors[:plaque_style].any? %>
                <p class="text-red-500 text-sm mt-2"><%= @order.errors[:plaque_style].first %></p>
              <% end %>
            </div>

            <!-- Style-specific Input Fields -->
            <div class="<%= 'hidden' unless @order.plaque_style.present? %>" id="message_section">
              
              <!-- Gold Metal Style -->
              <div class="style-input gold_metal <%= 'hidden' unless @order.plaque_style == 'gold_metal' %>">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">ğŸ¥‡ ê¸ˆì†íŒ¨ (ê³¨ë“œ) ì œì‘ ì •ë³´</h3>
                
                <%= form.label :plaque_message, "ìƒˆê¹€ ë¬¸êµ¬ *", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <p class="text-sm text-gray-600 mb-3">ê³ ê¸‰ìŠ¤ëŸ¬ìš´ ê³¨ë“œ ê¸ˆì†íŒ¨ì— ìƒˆê¸¸ ë¬¸êµ¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ë‚´ìš© ìµœëŒ€ 100ì)</p>
                <div class="relative">
                  <%= form.text_area :plaque_message, 
                        class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none #{'border-red-300' if @order.errors[:plaque_message].any?}",
                        rows: 3,
                        placeholder: "ì˜ˆ: ê°ì‚¬í•©ë‹ˆë‹¤ ì•„ë²„ë‹˜\ní‰ìƒ ê±´ê°•í•˜ì„¸ìš”\n2025.01.01",
                        required: @order.plaque_style == 'gold_metal',
                        data: { style: 'gold_metal' },
                        id: 'plaque_message_gold_metal' %>
                  <div class="absolute bottom-2 right-2 text-xs text-gray-400">
                    ìµœëŒ€ 50ì (3ì¤„ ê¶Œì¥)
                  </div>
                </div>
                <div class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                  <p class="text-sm text-yellow-800">ğŸ’¡ ê¸ˆì†íŒ¨ íŒ: ê°„ê²°í•˜ê³  ì„íŒ©íŠ¸ ìˆëŠ” ë¬¸êµ¬ê°€ ì¢‹ìŠµë‹ˆë‹¤</p>
                </div>
              </div>

              <!-- Silver Metal Style -->
              <div class="style-input silver_metal <%= 'hidden' unless @order.plaque_style == 'silver_metal' %>">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">ğŸ¥ˆ ê¸ˆì†íŒ¨ (ì‹¤ë²„) ì œì‘ ì •ë³´</h3>
                
                <%= form.label :plaque_message, "ìƒˆê¹€ ë¬¸êµ¬ *", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <p class="text-sm text-gray-600 mb-3">ì„¸ë ¨ëœ ì‹¤ë²„ ê¸ˆì†íŒ¨ì— ìƒˆê¸¸ ë¬¸êµ¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                <div class="relative">
                  <%= form.text_area :plaque_message, 
                        class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none #{'border-red-300' if @order.errors[:plaque_message].any?}",
                        rows: 3,
                        placeholder: "ì˜ˆ: ìš°ìˆ˜ì‚¬ì› í™ê¸¸ë™\níƒì›”í•œ ì„±ê³¼ë¥¼ ì¶•í•˜í•©ë‹ˆë‹¤\n2025ë…„ 1ì›”",
                        required: @order.plaque_style == 'silver_metal',
                        data: { style: 'silver_metal' },
                        id: 'plaque_message_silver_metal' %>
                  <div class="absolute bottom-2 right-2 text-xs text-gray-400">
                    ìµœëŒ€ 50ì (3ì¤„ ê¶Œì¥)
                  </div>
                </div>
                <div class="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-md">
                  <p class="text-sm text-gray-700">ğŸ’¡ ì‹¤ë²„íŒ¨ íŒ: ê¹”ë”í•˜ê³  ì „ë¬¸ì ì¸ ë¬¸êµ¬ê°€ ì–´ìš¸ë¦½ë‹ˆë‹¤</p>
                </div>
              </div>

              <!-- Acrylic Cartoon Style -->
              <div class="style-input acrylic_cartoon <%= 'hidden' unless @order.plaque_style == 'acrylic_cartoon' %>">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">ğŸ¨ ì•„í¬ë¦´íŒ¨ (ì¹´íˆ°) ì œì‘ ì •ë³´</h3>
                
                <%= form.label :plaque_message, "ì¹´íˆ° ìŠ¤íƒ€ì¼ ë¬¸êµ¬ *", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <p class="text-sm text-gray-600 mb-3">ê·€ì—¬ìš´ ì¹´íˆ° ìŠ¤íƒ€ì¼ë¡œ ì œì‘í•  ë¬¸êµ¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                <div class="relative">
                  <%= form.text_area :plaque_message, 
                        class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none #{'border-red-300' if @order.errors[:plaque_message].any?}",
                        rows: 4,
                        placeholder: "ì˜ˆ: ìš°ë¦¬ ê°€ì¡± ìµœê³ !\nì‚¬ë‘í•´ìš” í• ë¨¸ë‹ˆâ™¥\nê±´ê°•í•˜ì„¸ìš”\n2025ë…„",
                        required: @order.plaque_style == 'acrylic_cartoon',
                        data: { style: 'acrylic_cartoon' },
                        id: 'plaque_message_acrylic_cartoon' %>
                  <div class="absolute bottom-2 right-2 text-xs text-gray-400">
                    ìµœëŒ€ 80ì (4ì¤„ ê¶Œì¥)
                  </div>
                </div>
                <div class="mt-2 p-3 bg-pink-50 border border-pink-200 rounded-md">
                  <p class="text-sm text-pink-800">ğŸ’¡ ì¹´íˆ°íŒ¨ íŒ: ë°ê³  ë”°ëœ»í•œ í‘œí˜„ê³¼ ì´ëª¨í‹°ì½˜ì„ í™œìš©í•´ë³´ì„¸ìš”</p>
                </div>
              </div>

              <!-- Acrylic Realistic Style -->
              <div class="style-input acrylic_realistic <%= 'hidden' unless @order.plaque_style == 'acrylic_realistic' %>">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">ğŸ¨ ì•„í¬ë¦´íŒ¨ (ì‹¤ì‚¬) ì œì‘ ì •ë³´</h3>
                
                <%= form.label :plaque_message, "ì‹¤ì‚¬ ìŠ¤íƒ€ì¼ ë¬¸êµ¬ *", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <p class="text-sm text-gray-600 mb-3">ìƒìƒí•œ ì‹¤ì‚¬ ìŠ¤íƒ€ì¼ë¡œ ì œì‘í•  ë¬¸êµ¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                <div class="relative">
                  <%= form.text_area :plaque_message, 
                        class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none #{'border-red-300' if @order.errors[:plaque_message].any?}",
                        rows: 3,
                        placeholder: "ì˜ˆ: ê¹€ì² ìˆ˜ë‹˜\nì •ë…„í‡´ì„ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤\n30ë…„ê°„ ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤\n2025.02.28",
                        required: @order.plaque_style == 'acrylic_realistic',
                        data: { style: 'acrylic_realistic' },
                        id: 'plaque_message_acrylic_realistic' %>
                  <div class="absolute bottom-2 right-2 text-xs text-gray-400">
                    ìµœëŒ€ 100ì (4ì¤„ ê¶Œì¥)
                  </div>
                </div>
                <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
                  <p class="text-sm text-blue-800">ğŸ’¡ ì‹¤ì‚¬íŒ¨ íŒ: ì •í™•í•œ ë‚ ì§œì™€ ì •ì¤‘í•œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì„¸ìš”</p>
                </div>
              </div>

              <% if @order.errors[:plaque_message].any? %>
                <p class="text-red-500 text-sm mt-3"><%= @order.errors[:plaque_message].first %></p>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Navigation Buttons -->
        <div class="flex justify-between items-center pt-6 border-t border-gray-200">
          <% if @step > 1 %>
            <%= link_to "ì´ì „ìœ¼ë¡œ", edit_order_path(@order.naver_order_number, step: @step - 1), 
                  class: "btn-secondary" %>
          <% else %>
            <div></div>
          <% end %>

          <% if @step < 3 %>
            <%= form.submit "ë‹¤ìŒ ë‹¨ê³„", class: "btn-primary" %>
          <% else %>
            <%= form.submit "ì£¼ë¬¸ ì™„ë£Œ", class: "btn-primary" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
// Function to initialize everything
function initializePageFunctionality() {
  // Style selection functionality
  function setupStyleSelection() {
    const styleRadios = document.querySelectorAll('input[name="order[plaque_style]"]');
    const messageSection = document.getElementById('message_section');
    const styleInputs = document.querySelectorAll('.style-input');
    
    console.log('Setting up style selection - Found style radios:', styleRadios.length);
    console.log('Found message section:', messageSection);
    console.log('Found style inputs:', styleInputs.length);
    
    // Remove existing listeners and add new ones
    styleRadios.forEach(radio => {
      // Remove existing listener if any
      radio.removeEventListener('change', handleStyleChange);
      // Add new listener
      radio.addEventListener('change', handleStyleChange);
    });
    
    function handleStyleChange() {
      console.log('Style radio changed:', this.value, 'checked:', this.checked);
      
      if (this.checked) {
        const messageSection = document.getElementById('message_section');
        const styleInputs = document.querySelectorAll('.style-input');
        const allTextareas = document.querySelectorAll('textarea[name="order[plaque_message]"]');
        
        // Show message section
        if (messageSection) {
          console.log('Showing message section');
          messageSection.classList.remove('hidden');
          messageSection.classList.add('animate-fade-in');
        }
        
        // Remove required from all textareas first
        allTextareas.forEach(textarea => {
          textarea.removeAttribute('required');
        });
        
        // Hide all style inputs
        styleInputs.forEach(input => {
          input.classList.add('hidden');
        });
        
        // Show the selected style input
        const selectedStyleInput = document.querySelector(`.style-input.${this.value}`);
        console.log('Selected style input:', selectedStyleInput);
        
        if (selectedStyleInput) {
          console.log('Showing selected style input for:', this.value);
          selectedStyleInput.classList.remove('hidden');
          selectedStyleInput.classList.add('animate-fade-in');
          
          // Add required to the visible textarea
          const visibleTextarea = selectedStyleInput.querySelector('textarea[name="order[plaque_message]"]');
          if (visibleTextarea) {
            visibleTextarea.setAttribute('required', 'required');
            console.log('Added required to textarea for style:', this.value);
          }
        }
      }
    }
  }

  // Image slot functionality for main images
  function setupImageSlots() {
    const imageSlots = document.querySelectorAll('.image-slot');
    const mainImagesInput = document.getElementById('main_images_input');
    
    // Remove existing event listeners first to prevent duplicates
    imageSlots.forEach(slot => {
      // Remove any existing click listeners by cloning the element
      const newSlot = slot.cloneNode(true);
      slot.parentNode.replaceChild(newSlot, slot);
    });
    
    // Get fresh references after cloning
    const refreshedImageSlots = document.querySelectorAll('.image-slot');
    
    // Add click event listeners to refreshed slots
    refreshedImageSlots.forEach(slot => {
      slot.addEventListener('click', function() {
        mainImagesInput.click();
      });
    });
    
    if (mainImagesInput) {
      // Remove existing change listener
      mainImagesInput.removeEventListener('change', handleMainImageChange);
      // Add new change listener
      mainImagesInput.addEventListener('change', handleMainImageChange);
    }
  }
  
  // Separate function for main image change handling
  function handleMainImageChange(e) {
    const files = Array.from(e.target.files);
    const imageSlots = document.querySelectorAll('.image-slot');
    
    // Clear existing previews in slots
    imageSlots.forEach(slot => {
      slot.innerHTML = `
        <svg class="w-4 h-4 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        <span class="text-xs text-gray-500 mt-1">${slot.dataset.slot * 1 + 1}</span>
      `;
      slot.className = 'image-slot aspect-square border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center hover:border-blue-400 transition-all cursor-pointer text-center p-2';
      
      // Re-add click listener to cleared slot
      slot.addEventListener('click', function() {
        document.getElementById('main_images_input').click();
      });
    });
    
    // Show previews in slots
    files.slice(0, 5).forEach((file, index) => {
      if (file.type.startsWith('image/') && index < 5) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const slot = imageSlots[index];
          slot.innerHTML = `
            <img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">
            <div class="absolute top-1 right-1 bg-blue-500 text-white text-xs px-1.5 py-0.5 rounded">
              ${index + 1}
            </div>
          `;
          slot.className = 'image-slot aspect-square border-2 border-blue-500 rounded-lg relative overflow-hidden cursor-pointer';
          
          // Re-add click listener to image slot
          slot.addEventListener('click', function() {
            document.getElementById('main_images_input').click();
          });
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // Optional images preview with slots
  function handleOptionalImages() {
    const optionalImageSlots = document.querySelectorAll('.optional-image-slot');
    const optionalImagesInput = document.getElementById('optional_images_input');
    
    // Remove existing event listeners first to prevent duplicates
    optionalImageSlots.forEach(slot => {
      // Remove any existing click listeners by cloning the element
      const newSlot = slot.cloneNode(true);
      slot.parentNode.replaceChild(newSlot, slot);
    });
    
    // Get fresh references after cloning
    const refreshedOptionalSlots = document.querySelectorAll('.optional-image-slot');
    
    // Add click event listeners to refreshed slots
    refreshedOptionalSlots.forEach(slot => {
      slot.addEventListener('click', function() {
        optionalImagesInput.click();
      });
    });
    
    if (optionalImagesInput) {
      // Remove existing change listener
      optionalImagesInput.removeEventListener('change', handleOptionalImageChange);
      // Add new change listener
      optionalImagesInput.addEventListener('change', handleOptionalImageChange);
    }
  }
  
  // Separate function for optional image change handling
  function handleOptionalImageChange(e) {
    const files = Array.from(e.target.files);
    const optionalImageSlots = document.querySelectorAll('.optional-image-slot');
    
    // Clear existing previews in slots
    optionalImageSlots.forEach(slot => {
      slot.innerHTML = `
        <svg class="w-4 h-4 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        <span class="text-xs text-gray-500 mt-1">${slot.dataset.slot * 1 + 1}</span>
      `;
      slot.className = 'optional-image-slot aspect-square border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center hover:border-blue-400 transition-all cursor-pointer text-center p-2';
      
      // Re-add click listener to cleared slot
      slot.addEventListener('click', function() {
        document.getElementById('optional_images_input').click();
      });
    });
    
    // Show previews in slots
    files.slice(0, 5).forEach((file, index) => {
      if (file.type.startsWith('image/') && index < 5) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const slot = optionalImageSlots[index];
          slot.innerHTML = `
            <img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">
            <div class="absolute top-1 right-1 bg-green-500 text-white text-xs px-1.5 py-0.5 rounded">
              ì¶”ê°€ ${index + 1}
            </div>
          `;
          slot.className = 'optional-image-slot aspect-square border-2 border-green-500 rounded-lg relative overflow-hidden cursor-pointer';
          
          // Re-add click listener to image slot
          slot.addEventListener('click', function() {
            document.getElementById('optional_images_input').click();
          });
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // Character counter for message - updated for style-specific limits
  function setupCharacterCounter() {
    const messageTextareas = document.querySelectorAll('textarea[name="order[plaque_message]"]');
    
    messageTextareas.forEach(textarea => {
      const counter = textarea.parentNode.querySelector('.text-xs.text-gray-400');
      const style = textarea.dataset.style;
      
      // Set limits based on style
      let maxLength = 200;
      let label = 'ì';
      
      switch(style) {
        case 'gold_metal':
        case 'silver_metal':
          maxLength = 50;
          label = 'ì (3ì¤„ ê¶Œì¥)';
          break;
        case 'acrylic_cartoon':
          maxLength = 80;
          label = 'ì (4ì¤„ ê¶Œì¥)';
          break;
        case 'acrylic_realistic':
          maxLength = 100;
          label = 'ì (4ì¤„ ê¶Œì¥)';
          break;
      }
      
      textarea.addEventListener('input', function() {
        const length = this.value.length;
        counter.textContent = `${length}/${maxLength}${label}`;
        
        if (length > maxLength) {
          counter.classList.add('text-red-500');
          counter.classList.remove('text-gray-400');
        } else {
          counter.classList.add('text-gray-400');
          counter.classList.remove('text-red-500');
        }
      });
      
      // Initialize counter
      const length = textarea.value.length;
      counter.textContent = `${length}/${maxLength}${label}`;
    });
  }

  // Step 1 validation functions
  function validateStep1() {
    let isValid = true;
    
    // Validate orderer name
    const nameInput = document.getElementById('orderer_name_input');
    const nameError = document.getElementById('orderer_name_error');
    
    if (nameInput) {
      const name = nameInput.value.trim();
      if (!name) {
        nameError.textContent = 'ì£¼ë¬¸ì ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
        nameError.classList.remove('hidden');
        nameInput.classList.add('border-red-300');
        nameInput.classList.remove('border-gray-300');
        isValid = false;
      } else {
        nameError.classList.add('hidden');
        nameInput.classList.remove('border-red-300');
        nameInput.classList.add('border-gray-300');
      }
    }
    
    // Validate main images
    const imagesInput = document.getElementById('main_images_input');
    const imagesError = document.getElementById('main_images_error');
    
    if (imagesInput) {
      const hasImages = imagesInput.files.length > 0;
      if (!hasImages) {
        imagesError.textContent = 'ë©”ì¸ ì‚¬ì§„ì„ ìµœì†Œ 1ê°œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.';
        imagesError.classList.remove('hidden');
        isValid = false;
      } else {
        imagesError.classList.add('hidden');
      }
    }
    
    return isValid;
  }
  
  // Real-time validation setup
  function setupRealTimeValidation() {
    // Name input validation
    const nameInput = document.getElementById('orderer_name_input');
    if (nameInput) {
      nameInput.addEventListener('blur', validateStep1);
      nameInput.addEventListener('input', function() {
        if (this.value.trim()) {
          const nameError = document.getElementById('orderer_name_error');
          nameError.classList.add('hidden');
          this.classList.remove('border-red-300');
          this.classList.add('border-gray-300');
        }
      });
    }
    
    // Images input validation
    const imagesInput = document.getElementById('main_images_input');
    if (imagesInput) {
      imagesInput.addEventListener('change', function() {
        if (this.files.length > 0) {
          const imagesError = document.getElementById('main_images_error');
          imagesError.classList.add('hidden');
        }
        validateStep1();
      });
    }
  }
  
  // Form validation on submit
  function setupButtonValidation() {
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(e) {
        const stepInput = document.querySelector('input[name="step"]');
        const currentStep = stepInput ? stepInput.value : '1';
        
        // Validate based on current step
        if (currentStep === '1') {
          if (!validateStep1()) {
            e.preventDefault();
            
            // Scroll to first error
            const firstError = document.querySelector('.text-red-500:not(.hidden)');
            if (firstError) {
              firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        } else if (currentStep === '3') {
          // Step 3 validation - check if style and message are selected
          const completeStepInput = document.querySelector('input[name="complete_step"]');
          console.log('Step 3 submit - complete_step input found:', !!completeStepInput);
          
          if (completeStepInput) {
            const isValid = validateStep3();
            console.log('Step 3 validation result:', isValid);
            
            if (!isValid) {
              e.preventDefault();
              alert('ê¸°ë…íŒ¨ ìŠ¤íƒ€ì¼ê³¼ ë¬¸êµ¬ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            } else {
              console.log('Step 3 validation passed - form should submit');
            }
          }
        }
      });
    }
  }
  
  // Step 3 validation function
  function validateStep3() {
    // Check if style is selected
    const checkedRadio = document.querySelector('input[name="order[plaque_style]"]:checked');
    if (!checkedRadio) {
      return false;
    }
    
    // Check if message is filled for the selected style
    const visibleTextarea = document.querySelector(`.style-input.${checkedRadio.value}:not(.hidden) textarea[name="order[plaque_message]"]`);
    if (!visibleTextarea || !visibleTextarea.value.trim()) {
      return false;
    }
    
    return true;
  }

  // Initialize required attributes on page load
  function initializeRequiredAttributes() {
    const allTextareas = document.querySelectorAll('textarea[name="order[plaque_message]"]');
    const checkedRadio = document.querySelector('input[name="order[plaque_style]"]:checked');
    
    // Remove required from all textareas first
    allTextareas.forEach(textarea => {
      textarea.removeAttribute('required');
    });
    
    // Add required only to the visible one (if any style is selected)
    if (checkedRadio) {
      const selectedStyleInput = document.querySelector(`.style-input.${checkedRadio.value}`);
      if (selectedStyleInput) {
        const visibleTextarea = selectedStyleInput.querySelector('textarea[name="order[plaque_message]"]');
        if (visibleTextarea) {
          visibleTextarea.setAttribute('required', 'required');
          console.log('Initialized required attribute for:', checkedRadio.value);
        }
      }
    }
  }

  // Initialize all functionality
  initializeRequiredAttributes();
  setupStyleSelection();
  setupImageSlots();
  handleOptionalImages();
  setupCharacterCounter();
  setupRealTimeValidation();
  setupButtonValidation();
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', initializePageFunctionality);

// Initialize on Turbo navigation (for step changes)
document.addEventListener('turbo:load', initializePageFunctionality);

// Initialize on page visibility change (fallback)
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    setTimeout(initializePageFunctionality, 100);
  }
});
</script>

<style>
@keyframes fade-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
  animation: fade-in 0.3s ease-out;
}
</style>